---
title: "Visualization scIB"
author: "Marta Interlandi"
date: "9/11/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r setup_environment, message=FALSE, warning=FALSE}
library(ggplot2)
library(cowplot)
library(fmsb)
library(dplyr)
library(tidyr)
library(ggforce)
library(tibble)
library(RColorBrewer)
library(dynutils)
library(stringr)
library(R.utils)

setwd("/home/python_scRNA/Munich/visualization/")
source("./knit_table.R")


```

# Read output dataframe of summary metrics


Metrics in group 1:
- PCR batch
- ASW label/batch
- iLISI
- kBet

Metrics group 2:
- NMI
- ARI
- ASW label
- cLISI
- CC conservation

```{r read}

metrics_tab_lab <- read.csv("./collected_metrics_2.csv")
methods <- colnames(metrics_tab_lab)[-1]
metrics <- as.character(metrics_tab_lab[,1])

metrics_tab <- t(metrics_tab_lab)
metrics_tab[metrics_tab == ""] <- NA
metrics_tab <- as.data.frame(metrics_tab[-1,])
colnames(metrics_tab) <- plyr::mapvalues(metrics, from = c("ASW_label", "ASW_label/batch", "cell_cycle_conservation"), to = c("Cell type ASW", "Batch ASW", "CC conservation"))
colnames(metrics_tab) <- sub("_", " ", colnames(metrics_tab))

method_names <- sapply(str_split(rownames(metrics_tab), "_"), function(x) x[1])
method_names <- capitalize(method_names)
method_names <- plyr::mapvalues(method_names, from = c("Seurat", "Mnn", "Bbknn", "Trvae"), to = c("Seurat v3", "MNN", "BBKNN", "TrVAE"))

hvg <- sapply(str_split(rownames(metrics_tab), "_"), function(x) x[2])
hvg <- plyr::mapvalues(hvg, from = c("hvg2000", "hvg0"), to = c("HVG", ""))
row_groups <- sapply(str_split(rownames(metrics_tab), "_"), function(x) x[3])

metrics_tab <- add_column(metrics_tab, "Method" = method_names, .before = 1)
bbknn_ind <- grep("bbknn", rownames(metrics_tab))
lisi_ind <- grep("LISI", colnames(metrics_tab))
metrics_tab[bbknn_ind, lisi_ind] <- NA

# reorder columns by groups
col.ordered <- c("Method", "PCR batch", "Batch ASW", "iLISI", "kBET", "NMI cluster/label", "ARI cluster/label", "Cell type ASW", "cLISI", "CC conservation")
metrics_tab <- metrics_tab[, col.ordered]

metrics_tab[,-1] <- as.numeric(as.matrix(metrics_tab[, -1]))
metrics_tab[,-1] <- apply(metrics_tab[,-1], 2, function(x) scale_minmax(x))

score_group1 <- rowMeans(metrics_tab[, 2:5], na.rm = T)
score_group2 <- rowMeans(metrics_tab[, 6:10], na.rm = T)
score_all <- rowMeans(metrics_tab[, 2:10], na.rm = T) 
metrics_tab <- add_column(metrics_tab, "Overall Score" = score_all, .after = "Method")
metrics_tab <- add_column(metrics_tab, "Batch Correction" = score_group1, .after = "Overall Score")
metrics_tab <- add_column(metrics_tab, "Bio conservation" = score_group2, .after = "kBET")

metrics_tab <- add_column(metrics_tab, "method_group" = row_groups, .after = "Method")
metrics_tab <- add_column(metrics_tab, "HVG_label" = hvg, .after = "method_group")



# order methods by the overall score
metrics_tab <- metrics_tab[order(metrics_tab$method_group, metrics_tab$`Overall Score`,  decreasing = T), ]


method_group <- plyr::mapvalues(metrics_tab$method_group, from = c("knn", "embed", "full"), to = c("KNN", "Embeddings", "Features"))
metrics_tab <- metrics_tab[, colnames(metrics_tab) != "method_group"]


```


# Defining column_info, row_info and palettes

```{r cndio}

column_info <- data.frame(id = colnames(metrics_tab),
                          group = c("Text", "Text", "Score overall", rep("Removal of batch effects", 5), rep("Cell type label variance", 6)), 
                          geom = c("text", "text", "bar", "bar", rep("circle", 4), "bar", rep("circle", 5)),
                          width = c(3,2,2,2, rep(1,4), 2, rep(1,5)),
                          overlay = F)


palettes <- list("Score overall" = colorRampPalette(rev(brewer.pal(9, "YlGnBu")))(nrow(metrics_tab)),
                 "Removal of batch effects" = colorRampPalette(rev(brewer.pal(9, "BuPu")))(nrow(metrics_tab)),
                 "Cell type label variance" = colorRampPalette(rev(brewer.pal(9, "RdPu")))(nrow(metrics_tab)))

row_info <- data.frame(id = metrics_tab$Method, group = method_group)  


g <- scIB_knit_table(data = metrics_tab, column_info = column_info, row_info = row_info, palettes = palettes)  
ggsave("knit_summary_metrics.pdf", g, device = cairo_pdf, width = g$width/4, height = g$height/4)





```